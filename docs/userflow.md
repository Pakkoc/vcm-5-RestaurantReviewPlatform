# User Flow: 위치 기반 맛집 리뷰 플랫폼

## 문서 개요
본 문서는 위치 기반 맛집 리뷰 플랫폼의 기능별 상세 유저플로우를 정의합니다. 각 플로우는 입력(Input), 처리(Process), 출력(Output) 단계로 구성되며, 엣지케이스에 대한 처리를 포함합니다.

---

## UF-001: 메인 페이지 초기 로드

### 1. 입력 (Input)
- 사용자가 루트 URL(`/`)에 접속

### 2. 처리 (Process)
1. 페이지 레이아웃 렌더링 시작
2. 네이버 지도 SDK 스크립트 로드
3. 지도 API 초기화 요청
4. 기본 지도 설정 적용 (중심 좌표, 줌 레벨)
5. 백엔드 API 호출: `GET /api/restaurants/markers`
6. 리뷰가 존재하는 음식점 목록 조회
7. 각 음식점에 대해 지도 마커 생성
8. 마커에 이벤트 리스너 등록 (클릭, 호버)

#### 엣지케이스 처리
- **지도 SDK 로드 실패**: 
  - 재시도 로직 실행 (최대 3회)
  - 실패 시 에러 메시지 표시 및 검색 기능만 활성화
- **마커 데이터 조회 실패**:
  - 네트워크 에러 처리
  - 빈 배열로 처리하여 지도만 표시
- **좌표 데이터 누락**:
  - 해당 음식점 마커 생성 스킵
  - 에러 로깅

### 3. 출력 (Output)
- 네이버 지도가 화면 전체에 렌더링
- 로딩 스피너 제거
- 리뷰가 있는 음식점 위치에 마커 표시
- 상단 검색창 활성화
- 지도 조작 가능 상태 (확대/축소, 드래그)

#### 사이드 이펙트
- 지도 인스턴스가 전역 상태 또는 컨텍스트에 저장
- 마커 객체 배열이 메모리에 유지

---

## UF-002: 음식점 검색

### 1. 입력 (Input)
- 사용자가 검색창에 키워드 입력
- 검색 버튼 클릭 또는 Enter 키 입력

### 2. 처리 (Process)
1. 입력값 유효성 검사 (빈 문자열, 공백만 있는지 확인)
2. 입력값 트림 및 정규화
3. 로딩 상태 활성화
4. 네이버 검색 API 호출: `POST /api/restaurants/search`
   - 요청 바디: `{ keyword: "검색어" }`
5. 네이버 장소 검색 API로 프록시 요청
6. 응답 데이터 파싱 (상위 10개)
7. 각 검색 결과에 대해:
   - 음식점 정보 포맷팅
   - 내부 DB에 음식점 존재 여부 확인
   - 존재하지 않으면 임시 ID 생성
8. 검색 결과 모달 렌더링 준비

#### 엣지케이스 처리
- **입력값이 빈 문자열**:
  - 검색 실행하지 않음
  - 입력창에 포커스 유지
- **검색 결과 0개**:
  - 빈 결과 메시지 표시
  - 검색어 재입력 유도
- **API 호출 실패**:
  - 네트워크 타임아웃 (10초)
  - 에러 메시지 표시
  - 재시도 버튼 제공
- **API Rate Limit 초과**:
  - 일시적 사용 제한 안내
  - 재시도 대기 시간 표시
- **응답 데이터 형식 오류**:
  - 데이터 검증 실패 시 해당 항목 스킵
  - 유효한 결과만 표시
- **중복 검색 요청**:
  - 이전 요청 진행 중일 경우 취소
  - 최신 검색만 처리 (디바운싱)

### 3. 출력 (Output)
- 검색 결과 모달이 화면 중앙에 오버레이로 표시
- 모달 내용:
  - 검색어 표시
  - 결과 개수 표시
  - 음식점 목록 (최대 10개)
    - 각 항목: 음식점 이름, 주소, 카테고리, 리뷰 작성 버튼
- 모달 외부 영역 클릭 시 닫기 가능
- ESC 키로 모달 닫기 가능
- 로딩 상태 비활성화

#### 사이드 이펙트
- 검색 히스토리 로컬 스토리지에 저장 (선택 사항)
- 검색 결과 데이터가 컴포넌트 상태에 저장

---

## UF-003: 검색 결과 모달에서 리뷰 작성 버튼 클릭

### 1. 입력 (Input)
- 사용자가 검색 결과 목록에서 특정 음식점의 리뷰 작성 버튼 클릭

### 2. 처리 (Process)
1. 클릭된 음식점 데이터 추출
2. 음식점이 내부 DB에 존재하는지 확인
3. **DB에 존재하지 않는 경우**:
   - 음식점 정보 저장 API 호출: `POST /api/restaurants`
   - 요청 바디: 음식점 이름, 주소, 카테고리, 좌표, 네이버 플레이스 ID
   - 새로 생성된 음식점 ID 획득
4. **DB에 존재하는 경우**:
   - 기존 음식점 ID 사용
5. 리뷰 작성 페이지 URL 생성: `/review/create?restaurantId={id}`
6. 페이지 네비게이션 실행

#### 엣지케이스 처리
- **음식점 정보 저장 실패**:
  - 에러 메시지 토스트 표시
  - 재시도 버튼 제공
  - 네비게이션 중단
- **필수 정보 누락** (이름, 주소):
  - 음식점 정보 불완전 안내
  - 리뷰 작성 불가 메시지 표시
- **중복 저장 시도** (Race Condition):
  - 서버 측 Unique 제약조건으로 처리
  - 기존 레코드 ID 반환
- **네비게이션 실패**:
  - 라우터 에러 핸들링
  - 현재 페이지 유지 및 에러 표시

### 3. 출력 (Output)
- 리뷰 작성 페이지로 이동
- URL 쿼리 파라미터에 음식점 ID 포함
- 검색 결과 모달 자동 닫힘
- 페이지 전환 애니메이션

#### 사이드 이펙트
- 새 음식점이 DB에 저장될 수 있음
- 브라우저 히스토리에 새 엔트리 추가

---

## UF-004: 지도 마커 호버

### 1. 입력 (Input)
- 사용자가 지도 위의 마커에 마우스 커서를 올림 (hover)

### 2. 처리 (Process)
1. 마커 호버 이벤트 감지
2. 해당 마커와 연결된 음식점 데이터 조회
3. 음식점 상세 정보 API 호출 (캐시된 경우 캐시 사용): `GET /api/restaurants/{id}`
4. 응답 데이터에서 필요한 정보 추출:
   - 음식점 이름
   - 평균 평점
   - 음식 카테고리
   - 리뷰 개수
5. 툴팁 컴포넌트 렌더링
6. 마커 위치 기준으로 툴팁 위치 계산
7. 툴팁 표시

#### 엣지케이스 처리
- **데이터 조회 실패**:
  - 로딩 중 메시지 표시
  - 타임아웃 후에도 실패 시 기본 정보만 표시 (음식점 이름)
- **평균 평점 없음** (리뷰는 있지만 계산 오류):
  - 평점 정보 미표시
  - 리뷰 개수만 표시
- **카테고리 정보 없음**:
  - 카테고리 필드 숨김 또는 기본값 표시
- **마우스 빠른 이동**:
  - 디바운싱 적용 (100ms)
  - 이전 툴팁 즉시 제거
- **화면 경계 처리**:
  - 툴팁이 화면 밖으로 나갈 경우 위치 조정
  - 마커 반대편에 표시

### 3. 출력 (Output)
- 마커 근처에 툴팁 UI 표시
- 툴팁 내용:
  - 음식점 이름
  - 평균 평점 (별 아이콘 및 숫자)
  - 음식 카테고리
  - 리뷰 개수
- 마커에서 마우스가 벗어나면 툴팁 자동 사라짐
- 페이드 인/아웃 애니메이션

#### 사이드 이펙트
- 툴팁 컴포넌트가 DOM에 추가/제거
- API 응답이 캐시에 저장될 수 있음

---

## UF-005: 지도 마커 클릭

### 1. 입력 (Input)
- 사용자가 지도 위의 마커를 클릭

### 2. 처리 (Process)
1. 마커 클릭 이벤트 감지
2. 호버 툴팁 제거 (표시 중인 경우)
3. 해당 마커와 연결된 음식점 ID 추출
4. 음식점 세부 정보 페이지 URL 생성: `/restaurant/{restaurantId}`
5. 페이지 네비게이션 실행

#### 엣지케이스 처리
- **음식점 ID 누락**:
  - 에러 로깅
  - 사용자에게 에러 토스트 표시
  - 네비게이션 중단
- **연속 클릭**:
  - 디바운싱 적용 (300ms)
  - 첫 번째 클릭만 처리
- **네비게이션 중 에러**:
  - 라우터 에러 핸들링
  - 현재 페이지 유지

### 3. 출력 (Output)
- 음식점 세부 정보 페이지로 이동
- URL 파라미터에 음식점 ID 포함
- 페이지 전환 애니메이션

#### 사이드 이펙트
- 브라우저 히스토리에 새 엔트리 추가
- 이전 페이지 상태가 히스토리에 저장

---

## UF-006: 검색 결과 모달 닫기

### 1. 입력 (Input)
- 사용자가 모달 외부 영역 클릭, 또는
- ESC 키 입력, 또는
- 닫기 버튼 클릭 (존재하는 경우)

### 2. 처리 (Process)
1. 닫기 이벤트 감지
2. 모달 닫기 애니메이션 시작
3. 애니메이션 완료 대기
4. 모달 컴포넌트 언마운트
5. 검색 결과 데이터 상태 초기화 (선택 사항)

#### 엣지케이스 처리
- **애니메이션 중 재클릭**:
  - 중복 이벤트 무시
  - 진행 중인 애니메이션 완료 대기
- **모달 내부 클릭 시 버블링**:
  - 이벤트 전파 중단 (stopPropagation)
  - 모달 닫히지 않도록 처리

### 3. 출력 (Output)
- 모달이 페이드 아웃되며 사라짐
- 검색창 포커스 복원 (선택 사항)
- 지도가 다시 완전히 보임

#### 사이드 이펙트
- 모달 DOM 엘리먼트 제거
- 이벤트 리스너 정리
- 메모리 해제

---

## UF-007: 리뷰 작성 페이지 로드

### 1. 입력 (Input)
- 사용자가 리뷰 작성 페이지 URL로 접근: `/review/create?restaurantId={id}`

### 2. 처리 (Process)
1. URL 쿼리 파라미터에서 음식점 ID 추출
2. 음식점 ID 유효성 검사
3. 음식점 상세 정보 API 호출: `GET /api/restaurants/{id}`
4. 응답 데이터 파싱:
   - 음식점 이름
   - 전체 주소
   - 음식 카테고리
5. 페이지 컴포넌트 렌더링
6. 리뷰 작성 폼 초기화
7. 입력 필드 포커스 설정 (작성자명 필드)

#### 엣지케이스 처리
- **음식점 ID 누락**:
  - 메인 페이지로 리다이렉트
  - 에러 메시지 토스트 표시
- **유효하지 않은 ID 형식**:
  - 404 에러 페이지 표시
  - 메인 페이지로 돌아가기 버튼 제공
- **음식점 정보 조회 실패**:
  - 네트워크 에러 처리
  - 재시도 버튼 제공
  - 뒤로가기 버튼 활성화
- **음식점이 DB에 존재하지 않음**:
  - 404 에러 메시지
  - 메인 페이지로 리다이렉트 유도

### 3. 출력 (Output)
- 리뷰 작성 페이지 렌더링
- 헤더에 뒤로가기 버튼 표시
- 음식점 정보 섹션:
  - 음식점 이름 (큰 제목)
  - 전체 주소
  - 음식 카테고리
- 리뷰 작성 폼:
  - 작성자명 입력 필드 (비어있음, 포커스됨)
  - 평점 선택 UI (기본값 없음 또는 0점)
  - 리뷰 내용 텍스트 영역 (비어있음)
  - 비밀번호 입력 필드 (비어있음)
  - 리뷰 작성하기 버튼 (비활성화 상태)

#### 사이드 이펙트
- 음식점 정보가 컴포넌트 상태에 저장
- 페이지 뷰 이벤트 로깅 (선택 사항)

---

## UF-008: 리뷰 작성 폼 입력

### 1. 입력 (Input)
- 사용자가 리뷰 작성 폼의 각 필드에 데이터 입력:
  - 작성자명 입력
  - 평점 선택 (별 클릭)
  - 리뷰 내용 입력
  - 비밀번호 입력

### 2. 처리 (Process)

#### 작성자명 입력
1. 입력값 실시간 업데이트
2. 문자 수 카운팅 (최대 20자)
3. 실시간 유효성 검사:
   - 공백만 있는지 확인
   - 특수문자 제한 (선택 사항)
4. 에러 메시지 표시/숨김

#### 평점 선택
1. 별 아이콘 클릭 이벤트 감지
2. 선택된 별 개수 (1~5) 저장
3. 시각적 피드백 (선택된 별 강조)

#### 리뷰 내용 입력
1. 입력값 실시간 업데이트
2. 문자 수 카운팅 (최소 10자, 최대 500자)
3. 실시간 유효성 검사
4. 남은 글자 수 또는 초과 글자 수 표시

#### 비밀번호 입력
1. 입력값 실시간 업데이트
2. 문자 수 카운팅 (최소 4자)
3. 실시간 유효성 검사
4. 비밀번호 강도 표시 (선택 사항)

#### 전체 폼 유효성 검사
1. 모든 필드 유효성 종합 확인
2. 리뷰 작성하기 버튼 활성화/비활성화 토글

#### 엣지케이스 처리
- **작성자명 20자 초과**:
  - 20자까지만 입력 가능하도록 제한
  - 에러 메시지 표시
- **리뷰 내용 500자 초과**:
  - 500자까지만 입력 가능하도록 제한
  - 초과 글자 수 표시
- **리뷰 내용 10자 미만**:
  - 최소 글자 수 안내 메시지
  - 버튼 비활성화 유지
- **비밀번호 4자 미만**:
  - 최소 글자 수 안내 메시지
  - 버튼 비활성화 유지
- **평점 미선택**:
  - 평점 선택 필수 안내
  - 버튼 비활성화 유지
- **공백만 입력**:
  - 유효하지 않은 입력으로 간주
  - 에러 메시지 표시
- **특수문자 제한** (선택 사항):
  - 허용되지 않는 문자 입력 방지
  - 안내 메시지 표시

### 3. 출력 (Output)
- 각 입력 필드에 실시간으로 값 반영
- 문자 수 카운터 업데이트
- 유효성 검사 결과에 따른 에러 메시지 표시/숨김
- 리뷰 작성하기 버튼 활성화/비활성화 상태 변경
- 평점 선택 시 별 아이콘 시각적 변경

#### 사이드 이펙트
- 폼 데이터가 컴포넌트 상태에 저장
- 입력 이벤트 로깅 (선택 사항)

---

## UF-009: 리뷰 작성 제출

### 1. 입력 (Input)
- 사용자가 리뷰 작성하기 버튼 클릭

### 2. 처리 (Process)
1. 버튼 클릭 이벤트 감지
2. 버튼 비활성화 (중복 제출 방지)
3. 로딩 상태 활성화
4. 폼 데이터 최종 유효성 검사:
   - 작성자명: 1~20자, 공백 아님
   - 평점: 1~5 범위
   - 리뷰 내용: 10~500자, 공백 아님
   - 비밀번호: 4자 이상
5. 유효성 검사 통과 시:
   - 비밀번호 암호화 처리 (프론트엔드에서 해싱 또는 백엔드로 전송)
   - 리뷰 작성 API 호출: `POST /api/restaurants/{restaurantId}/reviews`
   - 요청 바디:
     ```json
     {
       "author_name": "작성자명",
       "rating": 5,
       "content": "리뷰 내용",
       "password": "비밀번호"
     }
     ```
6. API 응답 대기
7. 응답 성공 시:
   - 생성된 리뷰 ID 추출
   - 음식점 세부 정보 페이지로 네비게이션 준비
8. 응답 실패 시:
   - 에러 메시지 파싱

#### 엣지케이스 처리
- **유효성 검사 실패**:
  - 구체적인 에러 메시지 표시
  - 해당 필드에 포커스
  - 버튼 재활성화
- **네트워크 에러**:
  - 타임아웃 처리 (30초)
  - 에러 토스트 표시
  - 재시도 버튼 제공
  - 입력 데이터 유지
- **서버 에러 (500)**:
  - 일시적 오류 안내
  - 재시도 유도
  - 데이터 유지
- **중복 제출 시도**:
  - 버튼 비활성화로 방지
  - 이미 제출 중 메시지 표시
- **음식점 존재하지 않음 (404)**:
  - 음식점 삭제됨 안내
  - 메인 페이지로 리다이렉트
- **데이터 형식 오류 (400)**:
  - 서버 검증 메시지 표시
  - 해당 필드 수정 유도
- **비밀번호 해싱 실패**:
  - 에러 로깅
  - 재시도 로직

### 3. 출력 (Output)

#### 성공 시
- 성공 토스트 메시지 표시
- 음식점 세부 정보 페이지로 자동 리다이렉트: `/restaurant/{restaurantId}`
- 페이지 전환 애니메이션
- 새로 작성된 리뷰가 목록 상단에 표시됨

#### 실패 시
- 에러 토스트 또는 인라인 메시지 표시
- 버튼 재활성화
- 로딩 상태 비활성화
- 입력 데이터 유지 (사용자가 수정 가능)

#### 사이드 이펙트
- 새 리뷰가 데이터베이스에 저장
- 음식점 평균 평점 재계산
- 리뷰 개수 증가
- 음식점이 지도에 마커로 표시될 수 있음 (첫 리뷰인 경우)
- 브라우저 히스토리에 새 엔트리 추가

---

## UF-010: 뒤로가기 버튼 클릭 (리뷰 작성 페이지)

### 1. 입력 (Input)
- 사용자가 리뷰 작성 페이지 헤더의 뒤로가기 버튼 클릭

### 2. 처리 (Process)
1. 클릭 이벤트 감지
2. 입력 중인 데이터 존재 여부 확인
3. **데이터가 입력되어 있는 경우**:
   - 확인 다이얼로그 표시
   - 사용자 응답 대기
   - 확인 시: 네비게이션 진행
   - 취소 시: 현재 페이지 유지
4. **데이터가 없는 경우**:
   - 즉시 메인 페이지로 네비게이션
5. 브라우저 히스토리 백 또는 직접 라우팅

#### 엣지케이스 처리
- **데이터 입력 중**:
  - 데이터 손실 경고 다이얼로그
  - 사용자 의사 확인
- **확인 다이얼로그 무시**:
  - ESC 키나 외부 클릭 시 취소로 간주
  - 현재 페이지 유지
- **브라우저 뒤로가기 버튼 사용**:
  - beforeunload 이벤트 핸들링
  - 경고 메시지 표시 (브라우저 기본)

### 3. 출력 (Output)
- 메인 페이지(`/`)로 이동
- 페이지 전환 애니메이션
- 입력 중이던 데이터 폐기

#### 사이드 이펙트
- 입력 데이터 상태 초기화
- 컴포넌트 언마운트
- 메모리 해제

---

## UF-011: 음식점 세부 정보 페이지 로드

### 1. 입력 (Input)
- 사용자가 음식점 세부 정보 페이지 URL로 접근: `/restaurant/{restaurantId}`

### 2. 처리 (Process)
1. URL 파라미터에서 음식점 ID 추출
2. 음식점 ID 유효성 검사
3. 병렬 API 호출:
   - 음식점 상세 정보: `GET /api/restaurants/{id}`
   - 리뷰 목록: `GET /api/restaurants/{restaurantId}/reviews`
4. 음식점 정보 응답 처리:
   - 음식점 이름
   - 전체 주소
   - 음식 카테고리
   - 평균 별점 계산 (소수점 1자리)
   - 리뷰 개수
5. 리뷰 목록 응답 처리:
   - 최신순 정렬 (서버에서 정렬 또는 클라이언트 정렬)
   - 각 리뷰 데이터 포맷팅
6. 페이지 컴포넌트 렌더링

#### 엣지케이스 처리
- **음식점 ID 누락 또는 유효하지 않음**:
  - 404 에러 페이지 표시
  - 메인 페이지로 돌아가기 버튼
- **음식점 존재하지 않음 (404)**:
  - 음식점을 찾을 수 없음 메시지
  - 메인 페이지로 리다이렉트 유도
- **API 호출 실패**:
  - 음식점 정보 실패: 에러 메시지 및 재시도
  - 리뷰 목록 실패: 음식점 정보만 표시, 리뷰 로드 재시도 버튼
- **리뷰가 없는 경우**:
  - 빈 리뷰 메시지 표시
  - 첫 리뷰 작성 유도
- **평균 평점 계산 오류**:
  - 평점 정보 숨김 또는 기본값(0.0) 표시
- **대량의 리뷰**:
  - 초기 로드 시 일부만 표시 (예: 10개)
  - 더보기 버튼 또는 무한 스크롤 구현

### 3. 출력 (Output)
- 음식점 세부 정보 페이지 렌더링
- 헤더:
  - 뒤로가기 버튼
- 음식점 정보 섹션:
  - 음식점 이름 (큰 제목)
  - 전체 주소
  - 평균 별점 (별 아이콘 + 숫자, 예: ⭐ 4.5)
  - 리뷰 개수 (예: 12개의 리뷰)
- 리뷰 작성하기 버튼 (눈에 띄게 배치)
- 리뷰 목록:
  - 각 리뷰 카드:
    - 작성자명
    - 작성 날짜 (YYYY.MM.DD)
    - 별점 (별 아이콘)
    - 리뷰 내용 (전체 텍스트)
- 리뷰가 없을 경우: 안내 메시지

#### 사이드 이펙트
- 음식점 정보와 리뷰 데이터가 컴포넌트 상태에 저장
- 페이지 뷰 이벤트 로깅 (선택 사항)
- API 응답 캐싱 (선택 사항)

---

## UF-012: 음식점 세부 정보 페이지에서 리뷰 작성 버튼 클릭

### 1. 입력 (Input)
- 사용자가 음식점 세부 정보 페이지의 리뷰 작성하기 버튼 클릭

### 2. 처리 (Process)
1. 버튼 클릭 이벤트 감지
2. 현재 페이지의 음식점 ID 추출
3. 리뷰 작성 페이지 URL 생성: `/review/create?restaurantId={id}`
4. 페이지 네비게이션 실행

#### 엣지케이스 처리
- **음식점 ID 누락**:
  - 에러 로깅
  - 에러 토스트 표시
  - 네비게이션 중단
- **연속 클릭**:
  - 디바운싱 적용
  - 첫 클릭만 처리
- **네비게이션 실패**:
  - 라우터 에러 핸들링
  - 현재 페이지 유지

### 3. 출력 (Output)
- 리뷰 작성 페이지로 이동
- URL 쿼리 파라미터에 음식점 ID 포함
- 페이지 전환 애니메이션

#### 사이드 이펙트
- 브라우저 히스토리에 새 엔트리 추가
- 음식점 정보가 리뷰 작성 페이지에서 재사용될 수 있음 (캐시)

---

## UF-013: 뒤로가기 버튼 클릭 (음식점 세부 정보 페이지)

### 1. 입력 (Input)
- 사용자가 음식점 세부 정보 페이지 헤더의 뒤로가기 버튼 클릭

### 2. 처리 (Process)
1. 클릭 이벤트 감지
2. 브라우저 히스토리 확인
3. **히스토리가 존재하는 경우**:
   - 브라우저 뒤로가기 실행 (history.back())
4. **히스토리가 없는 경우** (직접 URL 접근):
   - 메인 페이지로 리다이렉트

#### 엣지케이스 처리
- **외부 사이트에서 직접 접근**:
  - 히스토리 없음
  - 메인 페이지로 안전하게 이동
- **새 탭에서 열림**:
  - 히스토리 없음
  - 메인 페이지로 이동

### 3. 출력 (Output)
- 이전 페이지 또는 메인 페이지로 이동
- 페이지 전환 애니메이션

#### 사이드 이펙트
- 컴포넌트 언마운트
- 상태 정리

---

## UF-014: 지도 조작 (확대/축소/드래그)

### 1. 입력 (Input)
- 사용자가 지도를 조작:
  - 마우스 휠로 줌 인/아웃
  - 줌 컨트롤 버튼 클릭
  - 지도 드래그하여 이동
  - 더블클릭으로 줌 인
  - 핀치 줌 (모바일)

### 2. 처리 (Process)
1. 지도 상호작용 이벤트 감지
2. 네이버 지도 SDK 내부 처리
3. 지도 뷰포트 변경
4. 뷰포트 영역 내 마커 가시성 업데이트
5. 필요 시 마커 클러스터링 재계산 (선택 사항)
6. 지도 상태 변경 이벤트 발생

#### 엣지케이스 처리
- **최대/최소 줌 레벨 도달**:
  - 더 이상 줌 불가 상태 처리
  - 시각적 피드백 (선택 사항)
- **지도 경계 밖으로 드래그**:
  - SDK에서 자동 제한
  - 또는 경계 설정 (한국 지역만 등)
- **빠른 연속 조작**:
  - 쓰로틀링 적용
  - 성능 최적화
- **마커가 너무 많을 때**:
  - 클러스터링 자동 적용
  - 가시 영역만 렌더링

### 3. 출력 (Output)
- 지도 뷰가 실시간으로 업데이트
- 마커 위치가 뷰에 따라 이동
- 줌 레벨 표시 업데이트 (선택 사항)
- 부드러운 애니메이션

#### 사이드 이펙트
- 지도 상태 (중심 좌표, 줌 레벨)가 메모리에 저장
- 로컬 스토리지에 마지막 위치 저장 (선택 사항)
- 가시 영역 변경 이벤트 발생

---

## UF-015: 리뷰 목록 스크롤

### 1. 입력 (Input)
- 사용자가 음식점 세부 정보 페이지의 리뷰 목록 영역을 스크롤

### 2. 처리 (Process)
1. 스크롤 이벤트 감지
2. 현재 스크롤 위치 계산
3. **무한 스크롤 구현 시**:
   - 스크롤이 하단에 가까워지는지 확인 (예: 80% 지점)
   - 다음 페이지 리뷰 데이터 요청
   - API 호출: `GET /api/restaurants/{restaurantId}/reviews?page={n}`
   - 응답 데이터를 기존 목록에 추가
   - 로딩 스피너 표시/숨김
4. **페이지네이션 구현 시**:
   - 스크롤 동작만 처리
   - 추가 로직 없음

#### 엣지케이스 처리
- **더 이상 불러올 리뷰 없음**:
  - API 응답으로 마지막 페이지 확인
  - 추가 요청 중단
  - 끝 메시지 표시 (선택 사항)
- **API 호출 중 추가 스크롤**:
  - 중복 요청 방지
  - 로딩 중 플래그 사용
- **네트워크 에러**:
  - 에러 메시지 표시
  - 재시도 버튼 제공
- **빠른 스크롤**:
  - 쓰로틀링 적용 (300ms)
  - 성능 최적화

### 3. 출력 (Output)
- 페이지가 자연스럽게 스크롤
- **무한 스크롤 시**:
  - 하단에 로딩 스피너 표시
  - 새 리뷰가 목록에 추가
  - 스크롤 위치 유지

#### 사이드 이펙트
- 추가 리뷰 데이터가 상태에 저장
- API 호출 발생 (무한 스크롤)
- 스크롤 위치가 브라우저에 저장

---

## UF-019: 음식점 정보 저장 (검색 결과에서)

### 1. 입력 (Input)
- 시스템이 네이버 검색 API에서 받은 음식점 정보
- 사용자가 리뷰 작성 버튼 클릭 시 트리거

### 2. 처리 (Process)
1. 음식점 네이버 플레이스 ID 추출
2. 내부 DB에 해당 ID로 음식점 존재 확인
3. **존재하지 않는 경우**:
   - 음식점 정보 저장 API 호출: `POST /api/restaurants`
   - 요청 바디:
     ```json
     {
       "name": "음식점 이름",
       "address": "전체 주소",
       "category": "음식 카테고리",
       "latitude": 37.123456,
       "longitude": 127.123456,
       "naver_place_id": "네이버 플레이스 ID"
     }
     ```
   - 응답에서 생성된 음식점 ID 획득
4. **이미 존재하는 경우**:
   - 기존 음식점 ID 반환

#### 엣지케이스 처리
- **필수 정보 누락** (이름, 주소, 좌표):
  - 저장 실패
  - 사용자에게 정보 불완전 안내
  - 리뷰 작성 불가 처리
- **중복 저장 시도** (Race Condition):
  - DB Unique 제약조건으로 처리
  - 충돌 시 기존 레코드 조회 후 반환
- **좌표 형식 오류**:
  - 유효성 검사 (위도 -90~90, 경도 -180~180)
  - 오류 시 저장 실패 처리
- **카테고리 정보 없음**:
  - NULL 또는 기본값으로 저장
  - 선택 필드로 처리
- **네이버 플레이스 ID 없음**:
  - NULL 허용 또는 임시 ID 생성
  - 추후 연동 개선 시 업데이트

### 3. 출력 (Output)
- 음식점 ID 반환
- 음식점 정보가 DB에 저장됨

#### 사이드 이펙트
- 새 음식점 레코드가 DB에 추가
- 타임스탬프 자동 기록
- 추후 해당 음식점에 마커 표시 가능

---

## UF-020: 리뷰 통계 업데이트

### 1. 입력 (Input)
- 새 리뷰가 DB에 저장된 후 트리거 (백엔드 자동 처리)

### 2. 처리 (Process)
1. 리뷰 저장 트랜잭션 완료
2. 해당 음식점의 모든 리뷰 조회
3. 평균 평점 재계산:
   - 총 평점 합계 / 리뷰 개수
   - 소수점 둘째 자리까지 계산, 첫째 자리로 반올림
4. 리뷰 개수 업데이트
5. 음식점 레코드 업데이트 (선택 사항: 캐시된 통계 필드)
6. 캐시 무효화 (해당 음식점 관련 캐시)

#### 엣지케이스 처리
- **첫 번째 리뷰**:
  - 평균 평점 = 리뷰 평점
  - 리뷰 개수 = 1
- **리뷰 삭제 시** (미래 기능):
  - 통계 재계산 트리거
  - 리뷰 0개 시 평균 평점 NULL 또는 0
- **동시 다발적 리뷰 작성**:
  - DB 트랜잭션으로 데이터 무결성 보장
  - Lock 처리 (Row-level Lock)
- **계산 오류**:
  - 에러 로깅
  - 기본값 유지 또는 다음 요청 시 재계산

### 3. 출력 (Output)
- 음식점 통계 업데이트 완료
- 다음 API 요청 시 최신 통계 반영

#### 사이드 이펙트
- 음식점 레코드의 updated_at 타임스탬프 갱신
- 캐시 갱신 또는 무효화
- 마커 툴팁 정보 업데이트 (다음 조회 시)

---

## UF-021: 비밀번호 검증 (미래 기능 - 리뷰 수정/삭제)

### 1. 입력 (Input)
- 사용자가 리뷰 수정 또는 삭제 버튼 클릭
- 비밀번호 입력 프롬프트에 비밀번호 입력

### 2. 처리 (Process)
1. 리뷰 ID와 입력된 비밀번호 수집
2. 비밀번호 검증 API 호출: `POST /api/reviews/{reviewId}/verify-password`
3. 요청 바디: `{ "password": "입력된 비밀번호" }`
4. 서버 측:
   - 입력 비밀번호 해싱
   - DB에 저장된 해시와 비교
   - 일치 여부 반환
5. **일치하는 경우**:
   - 수정/삭제 권한 부여
   - 해당 작업 진행
6. **일치하지 않는 경우**:
   - 에러 메시지 표시
   - 재입력 유도

#### 엣지케이스 처리
- **비밀번호 미입력**:
  - 검증 실행하지 않음
  - 입력 요청 메시지
- **연속 실패 (Brute Force 방지)**:
  - 3회 실패 시 일시적 차단 (5분)
  - IP 기반 Rate Limiting
- **리뷰 존재하지 않음**:
  - 404 에러 반환
  - 사용자에게 안내
- **비밀번호 해싱 알고리즘 변경**:
  - 다중 알고리즘 지원
  - 마이그레이션 로직

### 3. 출력 (Output)
- **성공**: 수정/삭제 UI 활성화
- **실패**: 에러 메시지 및 재입력 프롬프트

#### 사이드 이펙트
- 검증 시도 로깅 (보안)
- 실패 횟수 카운트 (세션 또는 IP 기반)

---

## 부록: 공통 에러 처리 원칙

### 에러 유형별 처리

#### 1. 네트워크 에러
- **표시**: 네트워크 연결 확인 메시지
- **액션**: 재시도 버튼 제공
- **로깅**: 에러 세부사항 기록

#### 2. 서버 에러 (5xx)
- **표시**: 일시적 서버 오류 안내
- **액션**: 자동 재시도 또는 재시도 버튼
- **로깅**: 에러 모니터링 시스템 알림

#### 3. 클라이언트 에러 (4xx)
- **400 Bad Request**: 입력 데이터 검증 메시지
- **401 Unauthorized**: (비로그인 서비스, 해당 없음)
- **404 Not Found**: 리소스를 찾을 수 없음 안내
- **429 Too Many Requests**: 일시적 사용 제한 안내

#### 4. 유효성 검사 에러
- **표시**: 구체적인 필드별 에러 메시지
- **액션**: 해당 필드로 포커스 이동
- **강조**: 에러 필드 시각적 표시 (빨간 테두리 등)

#### 5. SDK 로드 에러
- **표시**: 기능 제한 안내
- **액션**: 재시도 또는 대체 기능 제공
- **폴백**: 지도 없이 검색 기능만 사용

### 에러 메시지 원칙
- 사용자 친화적 언어 사용
- 구체적인 해결 방법 제시
- 기술 용어 최소화
- 적절한 톤 유지 (사과, 안내)

### 로깅 전략
- 클라이언트 에러: 브라우저 콘솔 및 에러 추적 서비스
- 네트워크 에러: 요청/응답 세부사항 기록
- 사용자 액션: 중요 이벤트만 선택적 로깅
- 개인정보: 로그에 포함하지 않음

---

## 문서 메타데이터

**문서 버전**: 1.0  
**작성일**: 2025-10-22  
**작성자**: Development Team  
**검토자**: Product Owner, UX Designer  
**다음 리뷰 예정일**: 2025-10-29  
**관련 문서**: 
- `docs/requirement.md`
- `docs/prd.md`

